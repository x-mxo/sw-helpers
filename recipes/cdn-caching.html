<!DOCTYPE html>
<html>

  








<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>Caching CDN Requests or Non-200 Responses</title>
  <meta name="description" content="(Currently Work in Progress) Service Worker helper libraries. ">

  <!-- The docs server over HTTPS, but site.github.url points to HTTP resouce causing mixed content -->
  <link rel="canonical" href="/recipes/cdn-caching.html">
  <link rel="alternate" type="application/rss+xml" title="sw-helpers" href="/feed.xml">

  <link rel="shortcut icon" href="/themes/images/favicon.ico">

  <!-- Stylesheet -->
  <link href="https://fonts.googleapis.com/css?family=Cutive+Mono|Open+Sans:300,300i,400,600,700" rel="stylesheet">
  <link href="/themes/styles/main.css" rel="stylesheet" type="text/css">

  
</head>


  <body>

    

















<section class="navigation-container">

  <!-- Hamburger Menu -->
  <button class="svg-btn navigation-open-btn js-menu-btn">
    <svg height="30" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
        <path d="M0 0h24v24H0z" fill="none"/>
        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
  </button>

  <nav class="navigation-links js-nav-drawer">
      <!-- Logo Header at Top of Nav Drawer -->
      <section class="nav-drawer-header">
        <img class="nav-drawer-header__logo" src="/themes/images/workbox-logo-grey-small.min.svg" alt="Small Workbox Logo" />

        <button class="svg-btn navigation-close-btn js-menu-close-btn">
          <svg height="30" viewBox="0 0 24 24" width="30" xmlns="http://www.w3.org/2000/svg">
            <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            <path d="M0 0h24v24H0z" fill="none"/>
          </svg>
        </button>
      </section>

      <!-- Actual Links -->
      <ul>
        
          
<li><a href="/">Getting Started</a></li>


        
          
<li><a href="/sw-cli">sw-cli</a></li>


        
          
<li><a href="/sw-build">sw-build</a></li>


        
          
<li><a href="/sw-lib">sw-lib</a></li>


        
          
<li class="drop-down-container js-drop-down-wrapper">
  <span class="navigation-drop-down-btn js-drop-down-btn">Recipes</span>
  <ul class="drop-down-list js-drop-down-list">
  
    
<li><a href="/recipes/webpack">Web Pack</a></li>


  
    
<li><a href="/recipes/gulp">Gulp</a></li>


  
    
<li><a href="/recipes/rollup">Rollup</a></li>


  
    
<li><a href="/recipes/grunt">Grunt</a></li>


  
  </ul>
</li>



        
          
<li><a href="/examples">Examples</a></li>


        
          
<li class="drop-down-container js-drop-down-wrapper">
  <span class="navigation-drop-down-btn js-drop-down-btn">Reference</span>
  <ul class="drop-down-list js-drop-down-list">
  
    
<li><a href="/reference-docs/stable/latest/module-sw-background-sync-queue.html">sw-background-sync-queue</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-broadcast-cache-update.html">sw-broadcast-cache-update</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-build.html">sw-build</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-cache-expiration.html">sw-cache-expiration</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-cacheable-response.html">sw-cacheable-response</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-lib.html">sw-lib</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-offline-google-analytics.html">sw-offline-google-analytics</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-precaching.html">sw-precaching</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-routing.html">sw-routing</a></li>


  
    
<li><a href="/reference-docs/stable/latest/module-sw-runtime-caching.html">sw-runtime-caching</a></li>


  
  </ul>
</li>



        
      </ul>
    </nav>

    <div class="nav-backdrop js-nav-backdrop"></div>

</section>


<header class="primary-header">
  <div class="primary-header__inner-section">
    <h1></h1>
  </div>
</header>


<main>
  <h1 id="caching-cdn-requests-or-non-200-responses">Caching CDN Requests or Non-200 Responses</h1>

<p>If an attempt is made to cache an asset that is on a different origin or
the asset returns a non-200 response, these modules will throw an error. The
reason for this default behavior is to ensure that only good and local
responses are cached.</p>

<p>Below are examples of how to cache third party content in sw-lib and
the lower level modules.</p>

<h2 id="sw-lib">sw-lib</h2>

<p>In sw-lib, you can set up some additional options with a route that will allow
custom status codes and / or responses with specific headers.</p>

<p>In sw-lib you can add options to caching strategies which support caching
responses with specific status codes, headers, or both.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">cdnCacheStrategy</span> <span class="o">=</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">swlib</span><span class="p">.</span><span class="nx">staleWhileRevalidate</span><span class="p">({</span>
  <span class="na">cacheableResponse</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">statuses</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">],</span>
  <span class="p">},</span>
<span class="p">});</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">swlib</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">registerRoute</span><span class="p">(</span><span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'^https://cdn.mysite.com/styles/'</span><span class="p">),</span> <span class="nx">cdnCacheStrategy</span><span class="p">);</span>
</code></pre>
</div>

<p>Use this approach with any of the caching strategies supported by
sw-lib including <code class="highlighter-rouge">cacheFirst()</code>, <code class="highlighter-rouge">cacheOnly()</code>, <code class="highlighter-rouge">networkFirst()</code>,
<code class="highlighter-rouge">networkOnly()</code> and <code class="highlighter-rouge">staleWhileRevalidate()</code>.</p>

<h2 id="lower-level-modules">Lower Level Modules</h2>

<p>When using the lower level modules, use the <code class="highlighter-rouge">sw-cacheable-response</code> plugin
with a <code class="highlighter-rouge">RequestWrapper</code> to cache responses with a non 2XX status code.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="c1">// The responses will be cached if the response code is 0, 200, or 404, and</span>
<span class="c1">// will not be cached otherwise.</span>
<span class="kr">const</span> <span class="nx">cacheablePlugin</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">cacheableResponse</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">({</span>
  <span class="na">statuses</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">404</span><span class="p">]</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">requestWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">runtimeCaching</span><span class="p">.</span><span class="nx">RequestWrapper</span><span class="p">({</span>
  <span class="na">cacheName</span><span class="p">:</span> <span class="s1">'runtime-cache'</span><span class="p">,</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">cacheablePlugin</span>
  <span class="p">]</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">routing</span><span class="p">.</span><span class="nx">RegExpRoute</span><span class="p">({</span>
  <span class="na">match</span><span class="p">:</span> <span class="p">({</span><span class="nx">url</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="nx">url</span><span class="p">.</span><span class="nx">domain</span> <span class="o">===</span> <span class="s1">'example.com'</span><span class="p">,</span>
  <span class="na">handler</span><span class="p">:</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">runtimeCaching</span><span class="p">.</span><span class="nx">StaleWhileRevalidate</span><span class="p">({</span><span class="nx">requestWrapper</span><span class="p">})</span>
<span class="p">});</span>
</code></pre>
</div>

<h1 id="fine-grained-request-caching">Fine Grained Request Caching</h1>

<p>If you need more than the ability to define static status and header values
you can create your own “plugin” which needs to implement the
<code class="highlighter-rouge">cacheWillUpdate</code> callback. Wherever this plugin is used, the <code class="highlighter-rouge">cacheWillUpdate</code>
callback will be executed with a
<a href="https://developer.mozilla.org/en-US/docs/Web/API/Response">Response</a> object as
an argument. Your callback should return a boolean where returning true results
in the response being cached.</p>

<p>In sw-lib, this can be achieved like so:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">myCustomPlugin</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">cacheWillUpdate</span><span class="p">:</span> <span class="p">({</span><span class="nx">response</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Or implement whatever other logic you want, e.g. check for 'x-no-sw: true'</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'cache-control'</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'no-cache'</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>
<span class="kr">const</span> <span class="nx">customCacheCriteria</span> <span class="o">=</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">swlib</span><span class="p">.</span><span class="nx">staleWhileRevalidate</span><span class="p">({</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">myCustomPlugin</span>
  <span class="p">],</span>
<span class="p">});</span>
<span class="nx">goog</span><span class="p">.</span><span class="nx">swlib</span><span class="p">.</span><span class="nx">router</span><span class="p">.</span><span class="nx">registerRoute</span><span class="p">(</span><span class="s1">'/some/url/'</span><span class="p">,</span> <span class="nx">customCacheCriteria</span><span class="p">);</span>
</code></pre>
</div>

<p>With the lower level modules use a custom plugin by passing it into
a request wrapper.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">myCustomPlugin</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">cacheWillUpdate</span><span class="p">:</span> <span class="p">({</span><span class="nx">response</span><span class="p">})</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// Or implement whatever other logic you want, e.g. check for 'x-no-sw: true'</span>
    <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">headers</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">'cache-control'</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'no-cache'</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">};</span>

<span class="kr">const</span> <span class="nx">requestWrapper</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">runtimeCaching</span><span class="p">.</span><span class="nx">RequestWrapper</span><span class="p">({</span>
  <span class="na">cacheName</span><span class="p">:</span> <span class="s1">'my-cache'</span><span class="p">,</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span><span class="nx">myCustomPlugin</span><span class="p">],</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">route</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">routing</span><span class="p">.</span><span class="nx">RegExpRoute</span><span class="p">({</span>
  <span class="na">regExp</span><span class="p">:</span> <span class="k">new</span> <span class="nb">RegExp</span><span class="p">(</span><span class="s1">'^https://example.com/api/'</span><span class="p">),</span>
  <span class="na">handler</span><span class="p">:</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">runtimeCaching</span><span class="p">.</span><span class="nx">StaleWhileRevalidate</span><span class="p">({</span><span class="nx">requestWrapper</span><span class="p">}),</span>
<span class="p">});</span>

<span class="kr">const</span> <span class="nx">router</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">goog</span><span class="p">.</span><span class="nx">routing</span><span class="p">.</span><span class="nx">Router</span><span class="p">();</span>
<span class="nx">router</span><span class="p">.</span><span class="nx">registerRoute</span><span class="p">({</span><span class="nx">route</span><span class="p">});</span>
</code></pre>
</div>

</main>

<footer>
  <a href="https://GoogleChrome.github.io/workbox" class="footer__btn footer__workbox-btn" role="button" title="Workbox">
    <img src="/themes/images/workbox-logo-white.min.svg" alt="Workbox Logo" />
  </a>
  <div class="footer__right-logos">
    <div class="footer__logo-row">
      <a href="https://twitter.com/ChromiumDev" class="footer__btn footer__twitter-btn" role="button" title="Twitter">
        <img src="/themes/images/twitter-logo.min.svg" alt="Twitter Logo" />
      </a>
      <a href="https://github.com/GoogleChrome/sw-helpers" class="footer__btn footer__github-btn" role="button" title="GitHub">
        <img src="/themes/images/github-logo.min.svg" alt="Github Logo" />
      </a>
    </div>
    <div class="footer__logo-row">
      <a class="google-dev-logo footer__btn" href="https://developers.google.com/web/">
        <img src="/themes/images/google-dev-logo.min.svg" alt="Google Developers Logo" />
      </a>
    </div>
  </div>
</footer>



  </body>

  








<script src="/themes/scripts/detabinator.js" rel="stylesheet" async defer></script>
<script src="/themes/scripts/nav-drawer.js" rel="stylesheet" async defer></script>
<script src="/themes/scripts/jsdocs-collapse.js" rel="stylesheet" async defer></script>
<script src="/themes/scripts/navigation-controller.js" rel="stylesheet" async defer></script>
<script src="/themes/third_party/anchor-js/anchor.min.js" rel="stylesheet" id="anchorjsscript" async defer></script>


</html>
