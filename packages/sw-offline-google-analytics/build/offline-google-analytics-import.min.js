/*
 Copyright 2016 Google Inc. All Rights Reserved.
 Licensed under the Apache License, Version 2.0 (the "License");
 you may not use this file except in compliance with the License.
 You may obtain a copy of the License at

     http://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing, software
 distributed under the License is distributed on an "AS IS" BASIS,
 WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 See the License for the specific language governing permissions and
 limitations under the License.
*/
(function(a,b){'object'==typeof exports&&'undefined'!=typeof module?module.exports=b():'function'==typeof define&&define.amd?define(b):(a.goog=a.goog||{},a.goog.offlineGoogleAnalytics=b())})(this,function(){'use strict';var a={CACHE_NAME:'offline-google-analytics',IDB:{NAME:'offline-google-analytics',STORE:'urls',VERSION:1},MAX_ANALYTICS_BATCH_SIZE:20,STOP_RETRYING_AFTER:172800000,URL:{ANALYTICS_JS_PATH:'/analytics.js',COLLECT_PATH:'/collect',HOST:'www.google-analytics.com'}},b=function createCommonjsModule(q,r){return r={exports:{}},q(r,r.exports),r.exports}(function(q){'use strict';(function(){function toArray(s){return Array.prototype.slice.call(s)}function promisifyRequest(s){return new Promise(function(t,u){s.onsuccess=function(){t(s.result)},s.onerror=function(){u(s.error)}})}function promisifyRequestCall(s,t,u){var v,w=new Promise(function(x,y){v=s[t].apply(s,u),promisifyRequest(v).then(x,y)});return w.request=v,w}function promisifyCursorRequestCall(s,t,u){var v=promisifyRequestCall(s,t,u);return v.then(function(w){return w?new Cursor(w,v.request):void 0})}function proxyProperties(s,t,u){u.forEach(function(v){Object.defineProperty(s.prototype,v,{get:function(){return this[t][v]},set:function(w){this[t][v]=w}})})}function proxyRequestMethods(s,t,u,v){v.forEach(function(w){w in u.prototype&&(s.prototype[w]=function(){return promisifyRequestCall(this[t],w,arguments)})})}function proxyMethods(s,t,u,v){v.forEach(function(w){w in u.prototype&&(s.prototype[w]=function(){return this[t][w].apply(this[t],arguments)})})}function proxyCursorRequestMethods(s,t,u,v){v.forEach(function(w){w in u.prototype&&(s.prototype[w]=function(){return promisifyCursorRequestCall(this[t],w,arguments)})})}function Index(s){this._index=s}function Cursor(s,t){this._cursor=s,this._request=t}function ObjectStore(s){this._store=s}function Transaction(s){this._tx=s,this.complete=new Promise(function(t,u){s.oncomplete=function(){t()},s.onerror=function(){u(s.error)},s.onabort=function(){u(s.error)}})}function UpgradeDB(s,t,u){this._db=s,this.oldVersion=t,this.transaction=new Transaction(u)}function DB(s){this._db=s}proxyProperties(Index,'_index',['name','keyPath','multiEntry','unique']),proxyRequestMethods(Index,'_index',IDBIndex,['get','getKey','getAll','getAllKeys','count']),proxyCursorRequestMethods(Index,'_index',IDBIndex,['openCursor','openKeyCursor']),proxyProperties(Cursor,'_cursor',['direction','key','primaryKey','value']),proxyRequestMethods(Cursor,'_cursor',IDBCursor,['update','delete']),['advance','continue','continuePrimaryKey'].forEach(function(s){s in IDBCursor.prototype&&(Cursor.prototype[s]=function(){var t=this,u=arguments;return Promise.resolve().then(function(){return t._cursor[s].apply(t._cursor,u),promisifyRequest(t._request).then(function(v){return v?new Cursor(v,t._request):void 0})})})}),ObjectStore.prototype.createIndex=function(){return new Index(this._store.createIndex.apply(this._store,arguments))},ObjectStore.prototype.index=function(){return new Index(this._store.index.apply(this._store,arguments))},proxyProperties(ObjectStore,'_store',['name','keyPath','indexNames','autoIncrement']),proxyRequestMethods(ObjectStore,'_store',IDBObjectStore,['put','add','delete','clear','get','getAll','getKey','getAllKeys','count']),proxyCursorRequestMethods(ObjectStore,'_store',IDBObjectStore,['openCursor','openKeyCursor']),proxyMethods(ObjectStore,'_store',IDBObjectStore,['deleteIndex']),Transaction.prototype.objectStore=function(){return new ObjectStore(this._tx.objectStore.apply(this._tx,arguments))},proxyProperties(Transaction,'_tx',['objectStoreNames','mode']),proxyMethods(Transaction,'_tx',IDBTransaction,['abort']),UpgradeDB.prototype.createObjectStore=function(){return new ObjectStore(this._db.createObjectStore.apply(this._db,arguments))},proxyProperties(UpgradeDB,'_db',['name','version','objectStoreNames']),proxyMethods(UpgradeDB,'_db',IDBDatabase,['deleteObjectStore','close']),DB.prototype.transaction=function(){return new Transaction(this._db.transaction.apply(this._db,arguments))},proxyProperties(DB,'_db',['name','version','objectStoreNames']),proxyMethods(DB,'_db',IDBDatabase,['close']),['openCursor','openKeyCursor'].forEach(function(s){[ObjectStore,Index].forEach(function(t){t.prototype[s.replace('open','iterate')]=function(){var u=toArray(arguments),v=u[u.length-1],w=this._store||this._index,x=w[s].apply(w,u.slice(0,-1));x.onsuccess=function(){v(x.result)}}})}),[Index,ObjectStore].forEach(function(s){s.prototype.getAll||(s.prototype.getAll=function(t,u){var v=this,w=[];return new Promise(function(x){v.iterateCursor(t,function(y){return y?(w.push(y.value),void 0!==u&&w.length==u?void x(w):void y.continue()):void x(w)})})})});q.exports={open:function(s,t,u){var v=promisifyRequestCall(indexedDB,'open',[s,t]),w=v.request;return w.onupgradeneeded=function(x){u&&u(new UpgradeDB(w.result,x.oldVersion,w.transaction))},v.then(function(x){return new DB(x)})},delete:function(s){return promisifyRequestCall(indexedDB,'deleteDatabase',[s])}}})()});class IDBHelper{constructor(q,r,s){if(q==void 0||r==void 0||s==void 0)throw Error('name, version, storeName must be passed to the constructor.');this._name=q,this._version=r,this._storeName=s}_getDb(){return this._dbPromise?this._dbPromise:(this._dbPromise=b.open(this._name,this._version,(q)=>{q.createObjectStore(this._storeName)}).then((q)=>{return q}),this._dbPromise)}close(){return this._dbPromise?this._dbPromise.then((q)=>{q.close(),this._dbPromise=null}):void 0}put(q,r){return this._getDb().then((s)=>{const t=s.transaction(this._storeName,'readwrite'),u=t.objectStore(this._storeName);return u.put(r,q),t.complete})}delete(q){return this._getDb().then((r)=>{const s=r.transaction(this._storeName,'readwrite'),t=s.objectStore(this._storeName);return t.delete(q),s.complete})}get(q){return this._getDb().then((r)=>{return r.transaction(this._storeName).objectStore(this._storeName).get(q)})}getAllValues(){return this._getDb().then((q)=>{return q.transaction(this._storeName).objectStore(this._storeName).getAll()})}getAllKeys(){return this._getDb().then((q)=>{return q.transaction(this._storeName).objectStore(this._storeName).getAllKeys()})}}const c=new IDBHelper(a.IDB.NAME,a.IDB.VERSION,a.IDB.STORE);var d=(q,r)=>{const s=new URL(q.url);return q.text().then((t)=>{return t&&(s.search=t),c.put(s.toString(),r||Date.now())})};class LogGroup{constructor({title:q,isPrimary:r}={}){this._isPrimary=r||!1,this._groupTitle=q||'',this._logs=[],this._childGroups=[],this._isFirefox=!1,/Firefox\/\d*\.\d*/.exec(navigator.userAgent)&&(this._isFirefox=!0),this._isEdge=!1,/Edge\/\d*\.\d*/.exec(navigator.userAgent)&&(this._isEdge=!0)}addLog(q){this._logs.push(q)}addChildGroup(q){0===q._logs.length||this._childGroups.push(q)}print(){return this._isEdge?this._printEdgeFriendly():void(this._openGroup(),this._logs.forEach((q)=>{this._printLogDetails(q)}),this._childGroups.forEach((q)=>{q.print()}),this._closeGroup())}_printEdgeFriendly(){this._logs.forEach((q)=>{let s=q.message;'string'==typeof s&&(s=s.replace(/%c/g,''));const t=[s];q.error&&t.push(q.error),q.args&&t.push(q.args);const u=q.logFunc||console.log;u(...t)}),this._childGroups.forEach((q)=>{q.print()})}_printLogDetails(q){const r=q.logFunc?q.logFunc:console.log;let s=q.message,t=[s];q.colors&&!this._isEdge&&(t=t.concat(q.colors)),q.args&&(t=t.concat(q.args)),r(...t)}_openGroup(){if(this._isPrimary){if(0===this._childGroups.length)return;const q=this._logs.shift();if(this._isFirefox)return void this._printLogDetails(q);q.logFunc=console.group,this._printLogDetails(q)}else console.groupCollapsed(this._groupTitle)}_closeGroup(){this._isPrimary&&0===this._childGroups.length||console.groupEnd()}}self.goog=self.goog||{},self.goog.LOG_LEVEL=self.goog.LOG_LEVEL||{none:-1,verbose:0,debug:1,warn:2,error:3};const e=`#bdc3c7`,f=`#7f8c8d`,g=`#2ecc71`,h=`#f1c40f`,i=`#e74c3c`,j=`#3498db`;var k=new class LogHelper{constructor(){this._defaultLogLevel='localhost'===location.hostname?self.goog.LOG_LEVEL.debug:self.goog.LOG_LEVEL.none}log(q){this._printMessage(self.goog.LOG_LEVEL.verbose,q)}debug(q){this._printMessage(self.goog.LOG_LEVEL.debug,q)}warn(q){this._printMessage(self.goog.LOG_LEVEL.warn,q)}error(q){this._printMessage(self.goog.LOG_LEVEL.error,q)}_printMessage(q,r){if(this._shouldLogMessage(q,r)){const s=this._getAllLogGroups(q,r);s.print()}}_getAllLogGroups(q,r){const s=new LogGroup({isPrimary:!0,title:'sw-helpers log.'}),t=this._getPrimaryMessageDetails(q,r);if(s.addLog(t),r.error){const v={message:r.error,logFunc:console.error};s.addLog(v)}const u=new LogGroup({title:'Extra Information.'});if(r.that&&r.that.constructor&&r.that.constructor.name){const v=r.that.constructor.name;u.addLog(this._getKeyValueDetails('class',v))}return r.data&&('object'!=typeof r.data||r.data instanceof Array?u.addLog(this._getKeyValueDetails('additionalData',r.data)):Object.keys(r.data).forEach((v)=>{u.addLog(this._getKeyValueDetails(v,r.data[v]))})),s.addChildGroup(u),s}_getKeyValueDetails(q,r){return{message:`%c${q}: `,colors:[`color: ${j}`],args:r}}_getPrimaryMessageDetails(q,r){let s,t;q===self.goog.LOG_LEVEL.verbose?(s='Info',t=e):q===self.goog.LOG_LEVEL.debug?(s='Debug',t=g):q===self.goog.LOG_LEVEL.warn?(s='Warn',t=h):q===self.goog.LOG_LEVEL.error?(s='Error',t=i):void 0;let u=`%cðŸ”§ %c[${s}]`;const v=[`color: ${e}`,`color: ${t}`];let w;return'string'==typeof r?w=r:r.message&&(w=r.message),w&&(w=w.replace(/\s+/g,' '),u+=`%c ${w}`,v.push(`color: ${f}; font-weight: normal`)),{message:u,colors:v}}_shouldLogMessage(q,r){if(!r)return!1;let s=this._defaultLogLevel;return self&&self.goog&&'number'==typeof self.goog.logLevel&&(s=self.goog.logLevel),s===self.goog.LOG_LEVEL.none||q<s?!1:!0}};const l=new IDBHelper(a.IDB.NAME,a.IDB.VERSION,a.IDB.STORE);var m=(q)=>{return q=q||{},l.getAllKeys().then((r)=>{return Promise.all(r.map((s)=>{return l.get(s).then((t)=>{const u=Date.now()-t,v=new URL(s);if(u>a.STOP_RETRYING_AFTER)return;if(!('searchParams'in v))return;let w=q.parameterOverrides||{};w.qt=u,Object.keys(w).sort().forEach((y)=>{v.searchParams.set(y,w[y])});let x=q.hitFilter;if('function'==typeof x)try{x(v.searchParams)}catch(y){return}return fetch(v.toString())}).then(()=>l.delete(s))}))})};return{initialize:(q)=>{q=q||{};let r=!1;self.addEventListener('fetch',(s)=>{const t=new URL(s.request.url),u=s.request;if(t.hostname===a.URL.HOST)if(t.pathname===a.URL.COLLECT_PATH){const v=u.clone();s.respondWith(fetch(u).then((w)=>{return r&&m(q),r=!1,w},()=>{return k.log('Enqueuing failed request...'),r=!0,d(v).then(()=>Response.error())}))}else t.pathname===a.URL.ANALYTICS_JS_PATH&&s.respondWith(caches.open(a.CACHE_NAME).then((v)=>{return fetch(u).then((w)=>{return v.put(u,w.clone()).then(()=>w)}).catch((w)=>{return k.error(w),v.match(u)})}))}),m(q)}}});
//# sourceMappingURL=offline-google-analytics-import.min.js.map
